!function(e,t){"object"==typeof exports&&"object"==typeof module?module.exports=t(require("core-js/modules/web.dom-collections.iterator"),require("lodash/isEqual"),require("@finos/perspective-viewer/dist/esm/utils.js"),require("@finos/perspective/dist/esm/config"),require("core-js/modules/es.array.unscopables.flat")):"function"==typeof define&&define.amd?define(["core-js/modules/web.dom-collections.iterator","lodash/isEqual","@finos/perspective-viewer/dist/esm/utils.js","@finos/perspective/dist/esm/config","core-js/modules/es.array.unscopables.flat"],t):"object"==typeof exports?exports["perspective-viewer-datagrid"]=t(require("core-js/modules/web.dom-collections.iterator"),require("lodash/isEqual"),require("@finos/perspective-viewer/dist/esm/utils.js"),require("@finos/perspective/dist/esm/config"),require("core-js/modules/es.array.unscopables.flat")):e["perspective-viewer-datagrid"]=t(e["core-js/modules/web.dom-collections.iterator"],e["lodash/isEqual"],e["@finos/perspective-viewer/dist/esm/utils.js"],e["@finos/perspective/dist/esm/config"],e["core-js/modules/es.array.unscopables.flat"])}(window,(function(e,t,i,s,r){return function(e){var t={};function i(s){if(t[s])return t[s].exports;var r=t[s]={i:s,l:!1,exports:{}};return e[s].call(r.exports,r,r.exports,i),r.l=!0,r.exports}return i.m=e,i.c=t,i.d=function(e,t,s){i.o(e,t)||Object.defineProperty(e,t,{enumerable:!0,get:s})},i.r=function(e){"undefined"!=typeof Symbol&&Symbol.toStringTag&&Object.defineProperty(e,Symbol.toStringTag,{value:"Module"}),Object.defineProperty(e,"__esModule",{value:!0})},i.t=function(e,t){if(1&t&&(e=i(e)),8&t)return e;if(4&t&&"object"==typeof e&&e&&e.__esModule)return e;var s=Object.create(null);if(i.r(s),Object.defineProperty(s,"default",{enumerable:!0,value:e}),2&t&&"string"!=typeof e)for(var r in e)i.d(s,r,function(t){return e[t]}.bind(null,r));return s},i.n=function(e){var t=e&&e.__esModule?function(){return e.default}:function(){return e};return i.d(t,"a",t),t},i.o=function(e,t){return Object.prototype.hasOwnProperty.call(e,t)},i.p="",i(i.s=8)}([function(t,i){t.exports=e},function(e,i){e.exports=t},function(e,t){e.exports=i},function(e,t,i){(e.exports=i(6)(!1)).push([e.i,'perspective-viewer>div{position:absolute;overflow:hidden;top:12px;left:12px;right:12px;bottom:12px}:host th,perspective-viewer th{text-align:center;position:relative}:host thead tr:not(:last-child) th,perspective-viewer thead tr:not(:last-child) th{overflow:hidden;max-width:0}:host tbody .pd-float,:host thead tr:last-child .pd-float,perspective-viewer tbody .pd-float,perspective-viewer thead tr:last-child .pd-float{text-align:right}:host tbody .pd-integer,:host thead .pd-integer,perspective-viewer tbody .pd-integer,perspective-viewer thead .pd-integer{text-align:right}:host .pd-positive,perspective-viewer .pd-positive{color:#1078d1}:host .pd-negative,perspective-viewer .pd-negative{color:#de3838}:host span.pd-tree-container,perspective-viewer span.pd-tree-container{display:flex;align-items:center;height:100%}:host tbody .pd-date,:host tbody .pd-datetime,:host tbody .pd-string,:host thead .pd-date,:host thead .pd-datetime,:host thead .pd-string,perspective-viewer tbody .pd-date,perspective-viewer tbody .pd-datetime,perspective-viewer tbody .pd-string,perspective-viewer thead .pd-date,perspective-viewer thead .pd-datetime,perspective-viewer thead .pd-string{text-align:left}:host tr td.pd-group-header,:host tr th,perspective-viewer tr td.pd-group-header,perspective-viewer tr th{border-right:1px solid #ddd}:host tr th:last-child,:host tr:last-child th:not(.pd-group-header),perspective-viewer tr th:last-child,perspective-viewer tr:last-child th:not(.pd-group-header){border-right:none}:host tr:last-child th,perspective-viewer tr:last-child th{border-bottom:1px solid #ddd}:host tr td span.pd-tree-group,perspective-viewer tr td span.pd-tree-group{margin-left:5px;margin-right:15px;border-left:1px solid #eee;height:100%}:host td,:host th,perspective-viewer td,perspective-viewer th{white-space:nowrap;font-size:12px;height:19px;padding:0 5px}:host tbody,perspective-viewer tbody{transition:opacity .2s ease-in}:host tbody:hover tr:hover td,perspective-viewer tbody:hover tr:hover td{background:#eee;opacity:1}:host table tr:hover,perspective-viewer table tr:hover{color:#333}:host tr,perspective-viewer tr{transition:background-color .2s ease-in,color .2s ease-in}:host table *,perspective-viewer table *{box-sizing:border-box}:host table,perspective-viewer table{position:absolute;overflow:hidden;color:#666}:host span.pd-row-header-icon,perspective-viewer span.pd-row-header-icon{color:#aaa;padding-right:4px;font-family:"Material Icons"}:host span.pd-column-header-icon,perspective-viewer span.pd-column-header-icon{font-size:10px;padding-left:3px;display:inline-block;width:10px;font-family:"Material Icons"}:host span.pd-row-header-icon:hover,perspective-viewer span.pd-row-header-icon:hover{color:#1a7da1;text-shadow:0 0 3px #1a7da1}:host .pd-selected td,perspective-viewer .pd-selected td{background-color:#eee}:host .pd-cell-clip,perspective-viewer .pd-cell-clip{overflow:hidden;text-overflow:ellipsis}:host td span.pd-group-name,:host th span.pd-group-name,perspective-viewer td span.pd-group-name,perspective-viewer th span.pd-group-name{margin-right:-5px;padding-right:5px;padding-left:8px;flex:1;height:100%}:host td span.pd-group-leaf,perspective-viewer td span.pd-group-leaf{margin-left:12px;height:100%}:host .pd-column-resize,perspective-viewer .pd-column-resize{height:100%;width:10px;position:absolute;top:0;right:0;cursor:col-resize}:host ::-webkit-scrollbar,perspective-viewer ::-webkit-scrollbar{width:8px;height:8px}:host :hover::-webkit-scrollbar-thumb,perspective-viewer :hover::-webkit-scrollbar-thumb{background-color:rgba(0,0,0,.3)}:host ::-webkit-scrollbar-thumb,perspective-viewer ::-webkit-scrollbar-thumb{border-radius:4px;background-color:rgba(0,0,0,0)}:host ::-webkit-scrollbar-corner,perspective-viewer ::-webkit-scrollbar-corner{background-color:rgba(0,0,0,0)}',""])},function(e,t){e.exports=s},function(e,t){e.exports=r},function(e,t){e.exports=function(e){var t=[];return t.toString=function(){return this.map((function(t){var i=function(e,t){var i=e[1]||"",s=e[3];if(!s)return i;if(t&&"function"==typeof btoa){var r=(n=s,"/*# sourceMappingURL=data:application/json;charset=utf-8;base64,"+btoa(unescape(encodeURIComponent(JSON.stringify(n))))+" */"),o=s.sources.map((function(e){return"/*# sourceURL="+s.sourceRoot+e+" */"}));return[i].concat(o).concat([r]).join("\n")}var n;return[i].join("\n")}(t,e);return t[2]?"@media "+t[2]+"{"+i+"}":i})).join("")},t.i=function(e,i){"string"==typeof e&&(e=[[null,e,""]]);for(var s={},r=0;r<this.length;r++){var o=this[r][0];"number"==typeof o&&(s[o]=!0)}for(r=0;r<e.length;r++){var n=e[r];"number"==typeof n[0]&&s[n[0]]||(i&&!n[2]?n[2]=i:i&&(n[2]="("+n[2]+") and ("+i+")"),t.push(n))}},t}},function(e,t,i){(e.exports=i(6)(!1)).push([e.i,"div.pd-scroll-container{position:absolute;top:0;left:0;right:0;bottom:0;overflow:overlay;-webkit-overflow-scrolling:auto}div.pd-virtual-panel{position:absolute;top:0;left:0;right:0;pointer-events:none}div.pd-scroll-table-clip{position:sticky;position:-webkit-sticky;top:0;left:0;overflow:hidden;width:100%;height:100%}div.pd-tree-container{display:flex;align-items:center;height:100%}slot{position:absolute;overflow:hidden}",""])},function(e,t,i){"use strict";i.r(t);var s=i(2);i(5),i(0);const r=new WeakMap,o=new WeakMap,n=!1,a={asc:"arrow_upward",desc:"arrow_downward","asc abs":"\u21e7","desc abs":"\u21e9","col asc":"arrow_back","col desc":"arrow_forward","col asc abs":"\u21e8","col desc abs":"\u21e6"};let l=[];function c(){const e=l.reduce((e,t)=>e+t,0)/l.length,t=l.length/5,i=1e3/e,s=l.length;console.log(`${e.toFixed(2)} ms/frame   ${t} rfps   ${i.toFixed(2)} vfps   (${s} frames in 5s)`),l=[]}function _(e,t,i){const s=new Map,r=i.value;return i.value=function(e){if(s.has(e))return s.get(e);{const t=r.call(this,e);return s.set(e,t),t}},i}function d(e,t){let i=t.split("|");return e[i[i.length-1]]}const h=(e,...t)=>e.map((e,i)=>[e,t[i]]).flat().filter(e=>!!e).join("");var p,u=i(4);function v(e,t,i){const s=this._format_class(t)(e),r=["pd-group-name"];return i&&r.push("pd-group-leaf"),s&&r.push(s),r.join(" ")}function m(e,t,i,s,r){const o=i[t.length-1],n=0===t.length?"TOTAL":t[t.length-1],a=v.call(this,n,o,s),l=function(e,t,i){const s=e.map(()=>'<span class="pd-tree-group"></span>');if(!i){const e=`<span class="pd-row-header-icon">${t?"remove":"add"}</span>`;s.push(e)}return s.join("")}(t,r,s),c=this._format_text(o)(n);e.classList.add("pd-group-header"),e.innerHTML=h` <span class="pd-tree-container"> ${l} <span class="${a}">${c}</span> </span> `}function f(e,t,i,s,r){var o={};return Object.keys(s).forEach((function(e){o[e]=s[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,s){return s(e,t,i)||i}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null),o}let w=(f((p=class{constructor(e,t,i){this._column_sizes=e,this._container=t,this.table=i,this.cells=[],this.rows=[]}num_rows(){return this.cells.length}_set_metadata(e,t){o.set(e,t)}_get_or_create_metadata(e){if(o.has(e))return o.get(e);{const t={};return o.set(e,t),t}}_format_text(e){const t=Object(u.get_type_config)(e),i=t.type||e,s={float:Intl.NumberFormat,integer:Intl.NumberFormat,datetime:Intl.DateTimeFormat,date:Intl.DateTimeFormat}[i];if(s){const e=new s("en-us",t.format);return t=>e.format(t)}return e=>e}_format_class(e){const t=Object(u.get_type_config)(e).type||e;return"integer"===t||"float"===t?e=>e>0?"pd-positive":e<0?"pd-negative":void 0:()=>""}_format(e){if(Array.isArray(e))return{format:m.bind(this)};const t=this._format_text(e),i=this._format_class(e);return{format(e,s){e.textContent=t(s);const r=i(s);r&&e.classList.add(r)}}}_get_cell(e="td",t,i,s){let r=t[i];return r||(r=t[i]=document.createElement(e),s.appendChild(r)),r}_get_row(e){let t=this.rows[e];t||(t=this.rows[e]=document.createElement("tr"),this.table.appendChild(t));let i=this.cells[e];return i||(i=this.cells[e]=[]),{tr:t,row_container:i}}_clean_columns(e){for(let t=0;t<this.rows.length;t++){const i=this.rows[t],s=this.cells[t];let r=e[t]||e;for(;i.children[r];)i.removeChild(i.children[r]);this.cells[t]=s.slice(0,r)}}_clean_rows(e){for(;this.table.children[e];)this.table.removeChild(this.table.children[e]);this.rows=this.rows.slice(0,e),this.cells=this.cells.slice(0,e)}}).prototype,"_format_text",[_],Object.getOwnPropertyDescriptor(p.prototype,"_format_text"),p.prototype),f(p.prototype,"_format_class",[_],Object.getOwnPropertyDescriptor(p.prototype,"_format_class"),p.prototype),f(p.prototype,"_format",[_],Object.getOwnPropertyDescriptor(p.prototype,"_format"),p.prototype),p);function g(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class b extends w{constructor(...e){super(...e),g(this,"_group_header_cache",[]),g(this,"_offset_cache",[])}_draw_group_th(e,t,i,s){const{tr:r,row_container:o}=this._get_row(t),n=this._get_cell("th",o,e[t],r);if(e[t]+=1,n.className="",n.removeAttribute("colspan"),n.style.minWidth="0",0===(null==s?void 0:s.length))n.innerHTML=h` <span>${i}</span> <span class="pd-column-resize"></span> `;else{const e=null==s?void 0:s.map(e=>{const t=a[e];return h` <span class="pd-column-header-icon">${t}</span> `}).join("");n.innerHTML=h` <span>${i}</span> ${e} <span class="pd-column-resize"></span> `}return n}_redraw_previous(e,t){const{tr:i,row_container:s}=this._get_row(t),r=e[t]-1;if(r<0)return;const o=this._get_cell("th",s,r,i);return o?(o.classList.add("pd-group-header"),o):void 0}_draw_group(e,t,i,s){const r=this._get_or_create_metadata(s);return r.column_path=e,r.column_name=t,r.column_type=i,r.is_column_header=!1,s.className="",r}_draw_th(e,t,i,s){const r=this._get_or_create_metadata(s);r.column_path=e,r.column_name=t,r.column_type=i,r.is_column_header=!0,r.size_key=`${e}|${i}`;const o=this._column_sizes.auto[r.size_key],n=this._column_sizes.override[r.size_key];return s.classList.add(`pd-${i}`),n?(s.classList.toggle("pd-cell-clip",o>n),s.style.minWidth=n+"px",s.style.maxWidth=n+"px"):o&&(s.classList.remove("pd-cell-clip"),s.style.maxWidth="",s.style.minWidth=o+"px"),r}get_column_header(e){const{tr:t,row_container:i}=this._get_row(this.rows.length-1);return this._get_cell("th",i,e,t)}draw(e,t,i,s,r){var o;const n=e.column_pivots.length+1;let a,l,c=null===(o=i.split)||void 0===o?void 0:o.call(i,"|"),_=!1;for(let o=0;o<n;o++)if(l=c[o]?c[o]:"",this._offset_cache[o]=this._offset_cache[o]||0,o<n-1){var d,h,p;if((null===(d=this._group_header_cache)||void 0===d?void 0:null===(h=d[o])||void 0===h?void 0:null===(p=h[0])||void 0===p?void 0:p.column_name)===l)a=this._group_header_cache[o][1],this._group_header_cache[o][2]+=1,a.setAttribute("colspan",this._group_header_cache[o][2]);else{a=this._draw_group_th(this._offset_cache,o,l,[]);const e=this._draw_group(i,l,s,a);this._group_header_cache[o]=[e,a,1],_=!0}}else{var u;_&&this._redraw_previous(this._offset_cache,o);const n=this._offset_cache[o],c=null===(u=e.sort)||void 0===u?void 0:u.filter(e=>e[0]===l).map(e=>e[1]);a=this._draw_group_th(this._offset_cache,o,l,c);const d=this._draw_th(t||i,l,s,a);d.vcidx=n,d.cidx=r;for(const[e]of this._group_header_cache)e.cidx=r,e.vcidx=n,e.size_key=d.size_key}1===n&&Array.isArray(s)&&a.classList.add("pd-group-header");const v=this._get_or_create_metadata(a);return this._clean_rows(this._offset_cache.length),{th:a,metadata:v}}clean(){this._clean_columns(this._offset_cache),this._offset_cache=[],this._group_header_cache=[]}}var y=i(1),x=i.n(y);class z extends w{_draw_td(e,t,i,s,{cidx:r,column_name:o,type:n},{selected_id:a,depth:l,ridx_offset:c,cidx_offset:_}){const{tr:d,row_container:h}=this._get_row(e);if(!1!==a){const e=x()(i,a),t=!e&&x()(null==i?void 0:i.slice(0,null==a?void 0:a.length),a);d.classList.toggle("pd-selected",!!i&&e),d.classList.toggle("pd-sub-selected",!!i&&t)}const p=this._get_cell("td",h,r,d),u=this._get_or_create_metadata(p);u.id=i,u.cidx=r+_,u.type=n,u.column=o,u.size_key=`${o}|${n}`,u.ridx=e+c,p.className=`pd-${n}`;const v=this._column_sizes.override[u.size_key];if(v){const e=this._column_sizes.auto[u.size_key];p.classList.toggle("pd-cell-clip",e>v),p.style.minWidth=v+"px",p.style.maxWidth=v+"px"}else p.classList.remove("pd-cell-clip"),p.style.minWidth="",p.style.maxWidth="";const m=this._format(n);return null==t?(p.textContent="-",u.value=null,u.row_path=null):m?(m.format(p,t,n,t.length===l,s),u.value=Array.isArray(t)?t[t.length-1]:t,u.row_path=i,u.is_open=s):(p.textContent=t,u.value=t),{td:p,metadata:u}}draw(e,t,i){const{cidx:s,column_data:r,id_column:o}=t;let n,a,{row_height:l}=i,c=0;for(const s of r){const _=r[c+1],d=null==o?void 0:o[c],h=this._draw_td(c++,s,d,(null==_?void 0:_.length)>(null==s?void 0:s.length),t,i);if(n=h.td,a=h.metadata,l=l||n.offsetHeight,c*l>e)break}return this._clean_rows(c),{td:n,cidx:s,ridx:c,metadata:a,row_height:l}}clean({ridx:e,cidx:t}){this._clean_rows(e),this._clean_columns(t)}}class k{constructor(e,t,i){i.innerHTML=h` <table cellspacing="0"> <thead></thead> <tbody></tbody> </table> `;const[s]=i.children,[r,o]=s.children;this.table=s,this._column_sizes=t,this.header=new b(t,e,r),this.body=new z(t,e,o),this.fragment=document.createDocumentFragment()}num_columns(){var e;return this.header._get_row(Math.max(0,(null===(e=this.header.rows)||void 0===e?void 0:e.length)-1||0)).row_container.length}autosize_cells(e){for(;e.length>0;){const[t,i]=e.shift(),s=t.offsetWidth;this._column_sizes.row_height=this._column_sizes.row_height||t.offsetHeight,this._column_sizes.indices[i.cidx]=s;const r=this._column_sizes.override.hasOwnProperty(i.size_key);s&&!r&&(this._column_sizes.auto[i.size_key]=s)}}async draw(e,t,i,s,r){const{width:o,height:n}=e,{view:a,config:l,column_paths:c,schema:_,table_schema:h}=t,p=c.slice(r.start_col),u=await a.to_columns(r),{start_row:v=0,start_col:m=0}=r,f=l.row_pivots.length,w=u.__ID__,g={viewport_width:0,selected_id:i,depth:f,ridx_offset:v,cidx_offset:m,row_height:this._column_sizes.row_height};let b,y=0,x=[];if("__ROW_PATH__"===c[0]){var z;const e=l.row_pivots.join(","),t=l.row_pivots.map(e=>h[e]),i={column_name:e,cidx:0,column_data:u.__ROW_PATH__,id_column:w,type:t},r=this.header.draw(l,e,"",t,0);b=this.body.draw(n,i,{...g,cidx_offset:0}),g.selected_id=!1,g.viewport_width+=this._column_sizes.indices[0]||(null===(z=b.td)||void 0===z?void 0:z.offsetWidth)||r.th.offsetWidth,g.row_height=g.row_height||b.row_height,y++,s||x.push([b.td||r.th,b.metadata||r.metadata])}try{for(;y<p.length;){var k;const e=p[y];if(!u[e]){let t=Math.max(r.end_col,0);r.start_col=t,r.end_col=t+1;const i=await a.to_columns(r);e in i||(i[e]=[]),u[e]=i[e]}const t=d(_,e),i={column_name:e,cidx:y,column_data:u[e],id_column:w,type:t},c=this.header.draw(l,void 0,e,t,y+m);if(b=this.body.draw(n,i,g),g.selected_id=!1,g.viewport_width+=this._column_sizes.indices[y+m]||(null===(k=b.td)||void 0===k?void 0:k.offsetWidth)||c.th.offsetWidth,g.row_height=g.row_height||b.row_height,y++,s||x.push([b.td||c.th,b.metadata||c.metadata]),g.viewport_width>o)break}return x}finally{var j;this.body.clean({ridx:(null===(j=b)||void 0===j?void 0:j.ridx)||0,cidx:y}),this.header.clean()}}}var j,L=i(7),O=i.n(L),E=i(3),M=i.n(E);function W(){return Reflect.construct(HTMLElement,[],this.__proto__.constructor)}Object.setPrototypeOf(W.prototype,HTMLElement.prototype),Object.setPrototypeOf(W,HTMLElement);let T=(P=(j=class extends W{constructor(){super()}create_shadow_dom(){this.attachShadow({mode:"open"});const e="<slot></slot>";this.shadowRoot.innerHTML=h` <style> ${O.a+M.a} </style> <div class="pd-scroll-container"> <div class="pd-virtual-panel">${this._virtual_scrolling_disabled?e:""}</div> <div class="pd-scroll-table-clip">${this._virtual_scrolling_disabled?"":e}</div> <div style="position: absolute; visibility: hidden;"></div> </div> `;const t=document.createElement("div"),[,i]=this.shadowRoot.children,[s,r,o]=i.children;this._sticky_container=t,this._table_clip=r,this._table_staging=o,this._scroll_container=i,this._virtual_panel=s}_calculate_viewport(e,t){const i=this._view_cache.config.row_pivots.length>0;if(this._virtual_scrolling_disabled)return{id:i};const{start_row:s,end_row:r}=this._calculate_row_range(e,t),{start_col:o,end_col:n}=this._calculate_column_range();return this._nrows=e,{start_col:o,end_col:n,start_row:s,end_row:r,id:i}}_calculate_row_range(e,t){const{height:i}=this._container_size,s=this._column_sizes.row_height||19,r=this._view_cache.config.column_pivots.length+1,o=Math.max(1,this._virtual_panel.offsetHeight-this._scroll_container.offsetHeight),n=this._scroll_container.scrollTop/o,a=i/s,l=t?e:this._nrows||0,c=Math.max(0,l+(r-a));let _=Math.ceil(c*n);return{start_row:_,end_row:_+a+1}}_calculate_column_range(){const e=Math.max(1,this._virtual_panel.offsetWidth-this._container_size.width),t=this._scroll_container.scrollLeft/e,i=this._max_scroll_column()+.5;let s=Math.floor(i*t);return{start_col:s,end_col:s+(this.table_model.num_columns()||1)+1}}_max_scroll_column(){let e=0;this._view_cache.config.row_pivots.length>0&&(e=this._column_sizes.indices[0]);let t=this._view_cache.column_paths.length;for(;e<this._container_size.width&&t>=0;)t--,e+=this._column_sizes.indices[t]||60;const i=this._view_cache.config.row_pivots.length>0;return Math.min(this._view_cache.column_paths.length-(i?2:1),t+(i?0:1))}_validate_viewport({start_col:e,end_col:t,start_row:i,end_row:s}){const r=this._start_col!==e,o=this._start_row!==i||this._end_row!==s||this._end_col!==t;return this._start_col=e,this._end_col=t,this._start_row=i,this._end_row=s,{invalid_column:r,invalid_row:o}}_needs_swap({invalid_row:e,invalid_column:t}){return this._invalid_schema||!1}_swap_in(e){this._render_element.dispatchEvent(new CustomEvent("perspective-datagrid-before-update",{bubbles:!0,detail:this})),this._virtual_scrolling_disabled||(this._needs_swap(e)?(this._sticky_container===this.table_model.table.parentElement&&this._sticky_container.replaceChild(this.table_model.table.cloneNode(!0),this.table_model.table),this._table_staging.appendChild(this.table_model.table)):this._sticky_container!==this.table_model.table.parentElement&&this._sticky_container.replaceChild(this.table_model.table,this._sticky_container.children[0]))}_swap_out(e){!this._virtual_scrolling_disabled&&this._needs_swap(e)&&this._sticky_container.replaceChild(this.table_model.table,this._sticky_container.children[0]),this._render_element.dispatchEvent(new CustomEvent("perspective-datagrid-after-update",{bubbles:!0,detail:this}))}_update_virtual_panel_width(e){if(e)if(this._virtual_scrolling_disabled)this._virtual_panel.style.width=this._column_sizes.indices.reduce((e,t)=>e+t,0)+"px";else{const e=Math.max(1,this._virtual_panel.offsetWidth-this._container_size.width),t=this._scroll_container.scrollLeft/e,i=this._max_scroll_column();let s=0,r=0;for(;s<i;)r+=this._column_sizes.indices[s]||60,s++;const o=this._container_size.width+r;this._virtual_panel.style.width=o+"px",this._scroll_container.scrollLeft=t*r}}_update_virtual_panel_height(e){const{row_height:t=19}=this._column_sizes,i=this.table_model.header.cells.length*t;let s;if(this._virtual_scrolling_disabled)s=e*t+i;else{const{height:r}=this._container_size,o=this._scroll_container.offsetHeight/(r-i);s=Math.min(1e7,e*t*o)}this._virtual_panel.style.height=`${s}px`}infer_options(e){if(e=Object.assign({},e),!this._view_cache)return{};const t=Object.assign({},this._view_cache.config);return delete t.sort,delete e.sort,{reset_scroll_position:!x()(e,t)}}async draw(e={}){const t=n&&performance.now(),{reset_scroll_position:i=!1,preserve_width:s=!1,invalid_viewport:r=!1}=e;if(void 0===this._view_cache.column_paths)return;i&&this.reset_scroll();const o=await this._view_cache.view.num_rows();this._virtual_scrolling_disabled?this._container_size={width:1/0,height:1/0}:this._container_size=!this._invalid_schema&&this._container_size||{width:this._sticky_container.offsetWidth,height:this._sticky_container.offsetHeight};const a=this._calculate_viewport(o,i),c=this._validate_viewport(a),{invalid_row:_,invalid_column:d}=c;if(this._update_virtual_panel_height(o),this._invalid_schema||_||d||r){this._swap_in(c);const e=await this.table_model.draw(this._container_size,this._view_cache,this._selected_id,s,a);this._swap_out(c),this.table_model.autosize_cells(e),s||this._update_virtual_panel_width(this._invalid_schema||d||r),this._invalid_schema=!1}var h;n&&(h=performance.now()-t,l.push(h))}}).prototype,C="draw",H=[s.throttlePromise],$=Object.getOwnPropertyDescriptor(j.prototype,"draw"),A=j.prototype,q={},Object.keys($).forEach((function(e){q[e]=$[e]})),q.enumerable=!!q.enumerable,q.configurable=!!q.configurable,("value"in q||q.initializer)&&(q.writable=!0),q=H.slice().reverse().reduce((function(e,t){return t(P,C,e)||e}),q),A&&void 0!==q.initializer&&(q.value=q.initializer?q.initializer.call(A):void 0,q.initializer=void 0),void 0===q.initializer&&(Object.defineProperty(P,C,q),q=null),j);var P,C,H,$,A,q,D;let N=(function(e,t,i,s,r){var o={};Object.keys(s).forEach((function(e){o[e]=s[e]})),o.enumerable=!!o.enumerable,o.configurable=!!o.configurable,("value"in o||o.initializer)&&(o.writable=!0),o=i.slice().reverse().reduce((function(i,s){return s(e,t,i)||i}),o),r&&void 0!==o.initializer&&(o.value=o.initializer?o.initializer.call(r):void 0,o.initializer=void 0),void 0===o.initializer&&(Object.defineProperty(e,t,o),o=null)}((D=class extends T{register_listeners(){this._scroll_container.addEventListener("scroll",this._on_scroll.bind(this),{passive:!1}),this._scroll_container.addEventListener("mousewheel",this._on_mousewheel.bind(this),{passive:!1}),this._sticky_container.addEventListener("mousedown",this._on_click.bind(this)),this._sticky_container.addEventListener("dblclick",this._on_dblclick.bind(this))}async _on_scroll(e){e.stopPropagation(),e.returnValue=!1,await this.draw(),this._render_element.dispatchEvent(new CustomEvent("perspective-datagrid-scroll"))}_on_mousewheel(e){if(this._virtual_scrolling_disabled)return;e.preventDefault(),e.returnValue=!1;const{offsetWidth:t,offsetHeight:i,scrollTop:s,scrollLeft:r}=this._scroll_container,o=Math.max(1,this._virtual_panel.offsetHeight-i),n=Math.max(1,this._virtual_panel.offsetWidth-t);this._scroll_container.scrollTop=Math.min(o,s+e.deltaY),this._scroll_container.scrollLeft=Math.min(n,r+e.deltaX),this._on_scroll(e)}async _on_dblclick(e){let t=e.target;for(;"TD"!==t.tagName&&"TH"!==t.tagName;)if(t=t.parentElement,!this._sticky_container.contains(t))return;const i=e.target.classList.contains("pd-column-resize"),s=o.get(t);if(i){await new Promise(setTimeout),delete this._column_sizes.override[s.size_key],delete this._column_sizes.auto[s.size_key],delete this._column_sizes.indices[s.cidx],t.style.minWidth="",t.style.maxWidth="";for(const e of this.table_model.body.cells){const t=e[s.cidx];t.style.minWidth="",t.style.maxWidth="",t.classList.remove("pd-cell-clip")}await this.draw({invalid_viewport:!0})}}async _on_click(e){if(0!==e.button)return;let t=e.target;for(;"TD"!==t.tagName&&"TH"!==t.tagName;)if(t=t.parentElement,!this._sticky_container.contains(t))return;const i=e.target.classList.contains("pd-row-header-icon"),s=e.target.classList.contains("pd-column-resize"),r=o.get(t);i?await this._on_toggle(e,r):s?this._on_resize_column(e,t,r):(null==r?void 0:r.is_column_header)?await this._on_sort(e,r):await this._on_select(r)}_on_resize_column(e,t,i){const s=e.pageX;t=this.table_model.header.get_column_header(i.vcidx);const r=this._column_sizes.indices[i.cidx],o=e=>this._on_resize_column_move(e,t,s,r,i),n=async()=>{document.removeEventListener("mousemove",o),document.removeEventListener("mouseup",n);const e=this._column_sizes.override[i.size_key];this._column_sizes.indices[i.cidx]=e,await this.draw({invalid_viewport:!0})};document.addEventListener("mousemove",o),document.addEventListener("mouseup",n)}async _on_resize_column_move(e,t,i,s,r){await new Promise(setTimeout);const o=e.pageX-i,n=s+o;if(this._column_sizes.override[r.size_key]=n,o<0)await this.draw({invalid_viewport:!0,preserve_width:!0});else{t.style.minWidth=n+"px",t.style.maxWidth=n+"px";const e=this._column_sizes.auto[r.size_key];for(const t of this.table_model.body.cells){const i=t[r.vcidx];i.style.maxWidth=i.style.minWidth=n+"px",i.classList.toggle("pd-cell-clip",e>n)}}}_get_selected(){return this._selected_id}_set_selected(e){this._selected_id=e}_clear_selected(){delete this._selected_id}async _on_select(e){if(!this._render_element.hasAttribute("selectable"))return;const t=x()(e.id,this._get_selected());let i=[];t?(this._clear_selected(),await this.draw({invalid_viewport:!0})):(this._set_selected(e.id),await this.draw({invalid_viewport:!0}),i=await async function({view:e,config:t},i,s){const r=t.row_pivots,o=t.column_pivots,n=i>=0?i:0,a=n+1,l=await e.to_json({start_row:n,end_row:a}),c=l.map(e=>e.__ROW_PATH__)[0]||[],_=r.map((e,t)=>{const i=c[t];return i?[e,"==",i]:void 0}).filter(e=>e),d=r.length>0?s+1:s,h=Object.keys(l[0])[d],p={row:l[0]};let u=[];if(h){const e=h.split("|");p.column_names=[e[e.length-1]],u=o.map((t,i)=>{const s=e[i];return s?[t,"==",s]:void 0}).filter(e=>e).filter(([,,e])=>"__ROW_PATH__"!==e)}const v=t.filter.concat(_).concat(u);return p.config={filters:v},p}(this._view_cache,e.ridx,e.cidx),i=i.config.filters),this._render_element.dispatchEvent(new CustomEvent("perspective-select",{bubbles:!0,composed:!0,detail:{selected:!t,config:{filters:i}}}))}async _on_toggle(e,t){t.is_open?e.shiftKey?await this._view_cache.view.set_depth(t.row_path.length-1):await this._view_cache.view.collapse(t.ridx):!1===t.is_open&&(e.shiftKey?await this._view_cache.view.set_depth(t.row_path.length):await this._view_cache.view.expand(t.ridx)),await this.draw({invalid_viewport:!0})}async _on_sort(e,t){let i=this._view_cache.config.sort.slice();const s=i.findIndex(e=>e[0]===t.column_name);if(s>-1){const r=i[s][1],o=this._render_element._increment_sort(r,!1,e.altKey);i[s]=[t.column_name,o]}else{let s=e.altKey?"asc abs":"asc";const r=[t.column_name,s];e.shiftKey?i.push(r):i=[r]}this._render_element.setAttribute("sort",JSON.stringify(i))}}).prototype,"_on_resize_column_move",[s.throttlePromise],Object.getOwnPropertyDescriptor(D.prototype,"_on_resize_column_move"),D.prototype),D);function R(e,t,i){return t in e?Object.defineProperty(e,t,{value:i,enumerable:!0,configurable:!0,writable:!0}):e[t]=i,e}class I{static async update(e){try{const t=r.get(e);await t.draw({invalid_viewport:!0})}catch(e){return}}static async create(e,t){const i=function(e,t){let i;return r.has(t)?i=r.get(t):(i=document.createElement("perspective-datagrid"),i.appendChild(document.createElement("slot")),i.set_element(e),i.register_listeners(),t.innerHTML="",t.appendChild(i),r.set(t,i)),i.isConnected||(i.clear(),t.innerHTML="",t.appendChild(i)),i}(this,e),s=await i.set_view(t);this._plugin_config&&(i.restore(this._plugin_config),delete this._plugin_config),await i.draw(s)}static async resize(){if(this.view&&r.has(this._datavis)){const e=r.get(this._datavis);e.reset_size(),await e.draw({invalid_viewport:!0})}}static delete(){if(this.view&&r.has(this._datavis)){r.get(this._datavis).clear()}}static save(){if(this.view&&r.has(this._datavis)){return r.get(this._datavis).save()}}static restore(e){if(this.view&&r.has(this._datavis)){r.get(this._datavis).restore(e)}else this._plugin_config=e}}R(I,"name","Datagrid"),R(I,"selectMode","toggle"),R(I,"deselectMode","pivots"),window.customElements.define("perspective-datagrid",class extends N{get_meta(e){return o.get(e)}get_tds(){return this.table_model.body.cells.flat(1)}get_ths(){return this.table_model.body.cells.flat(1)}clear(){this._sticky_container.innerHTML="<table></table>",this._render_element?this._render_element!==this.table_model.table.parentElement&&this._render_element.appendChild(this._sticky_container):this.appendChild(this.table_model.table)}reset_viewport(){this._start_row=void 0,this._end_row=void 0,this._start_col=void 0,this._end_col=void 0}reset_size(){this._container_size=void 0}reset_scroll(){this._column_sizes.indices=[],this._scroll_container.scrollTop=0,this._scroll_container.scrollLeft=0,this.reset_viewport()}async set_view(e){const t=await e.get_config(),i=await this._render_element.table.schema(),s=await e.schema(),r=await e.column_paths();this._invalid_schema=!0;const o=this.infer_options(t);return this._view_cache={view:e,config:t,column_paths:r,schema:s,table_schema:i},o}set_element(e){e&&(this._render_element=e),this._virtual_scrolling_disabled=e.hasAttribute("disable-virtual-datagrid"),this.create_shadow_dom(),this._column_sizes={auto:{},override:{},indices:[]},this.table_model=new k(this._table_clip,this._column_sizes,this._sticky_container),this.table_model&&(this._render_element?this._render_element!==this.table_model.table.parentElement&&this._render_element.appendChild(this._sticky_container):this.appendChild(this.table_model.table))}save(){const e=this._get_selected();if(void 0!==e)return{selected:e}}restore(e){e.selected&&this._set_selected(e.selected)}}),Object(s.registerPlugin)("datagrid",I),n&&setInterval(c,5e3),function(){const e=document.createElement("style");e.textContent=M.a,document.head.appendChild(e)}()}])}));
//# sourceMappingURL=perspective-viewer-datagrid.js.map
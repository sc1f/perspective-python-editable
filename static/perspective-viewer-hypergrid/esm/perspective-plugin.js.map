{"version":3,"sources":["../../src/js/perspective-plugin.js"],"names":["rectangular","superscript","isEqual","cellRenderersRegistry","Borders","BaseClass","extend","paint","gc","config","bounds","x","y","w","width","h","height","color","save","translate","cache","lineWidth","borderTop","beginPath","moveTo","lineTo","strokeStyle","stroke","borderRight","borderBottom","borderLeft","restore","add","setPSP","payload","force","new_schema","isTree","treeColumnIndex","name","toString","header","columnPaths","forEach","columnPath","columnIndex","col_name","join","aliases","configuration","columnAliases","type","columnTypes","push","index","grid","properties","showTreeColumn","behavior","dataModel","_config","column_only","row_pivots","length","column_pivots","selectable","_viewer","hasAttribute","addProperties","get_dynamic_styles","createColumns","refreshColumns","_memoized_schema","slice","rowPivots","_memoized_pivots","sbVScroller","data","rows","_data_window","undefined","sbHScroller","selectionModel","clear","setData","schema","Object","getPrototypeOf","call","setHeaders","schema_loaded","getActiveColumns","column","setColumnPropsByType","treeColumn","getTreeColumn","props","format","isEditable","editor","integer","string","date","datetime","float","assign","editable","editOnKeydown","editOnNextCell","editOnDoubleClick","editorActivationKeys","cellSelection","styles","get_styles","formatColumnHeader","value","getConfig","sort","findIndex","item","trim","direction","charMap","addSortChars","asc","desc","sortColumn","event","preventDefault","handled","getColumn","detail","column_sorting","column_name","split","viewer","item_index","already_sorted","abs_sorting","keys","indexOf","shift_pressed","new_sort_direction","_increment_sort","splice","JSON","stringify","right_click_handler","e","old_event","primitiveEvent","new_event","MouseEvent","target","parentElement","dispatchEvent","getCellConfig","row_idx","col_idx","start_row","end_row","r","_view","to_json","row_paths","map","__ROW_PATH__","row_pivots_values","row_filters","pivot","pivot_value","filter","column_index","column_paths","result","row","column_filters","column_pivot_values","column_names","filters","concat","install","addEventListener","bind","selected","canvas","CustomEvent","bubbles","composed","getCursorAt","rp_len","rowPath","is_select","rowSelection","gridPoint","updateCursor","cursor","hoverCell","getHScrollValue","getVScrollValue","beCursor","onMouseMove","featureChain","handleMouseMove","setCursor","cellClicked","dataCell","selected_rows","getSelectedRows","is_toggle","toggleRow","renderGrid","renderer","renderOverrides","renderLastSelection","shiftKey","stopPropagation","hasFocus","div","isConnected","grid_element","parentNode","host","view_shadow_root","activeElement","lookupFeature","handleMouseDown","dx","gridCell","dy","isSelectable","getCellProperty","isDataCell","isRightClick","dCell","newPoint","primEvent","extendSelection","next","hasCTRL","hasSHIFT","mousePoint","getMouseDown","clearMostRecentSelection","popMouseDown","repaint","clearSelections","select","setDragExtent","setMouseDown","handleDOWN","cellEditor","count","getAutoScrollAcceleration","getLastSelection","origin","max","dataWindow","extent","Math","min","getRowCount","handleUP","handleLEFT","handleRIGHT","moveShiftSelect","offsetX","offsetY","moveSingleSelect","update_bounds","floor","clientWidth","clientHeight","Rectangle","component","setBounds","resize","ratio","isHIDPI","window","devicePixelRatio","useHiDPI","backingStoreRatio","webkitBackingStorePixelRatio","mozBackingStorePixelRatio","msBackingStorePixelRatio","oBackingStorePixelRatio","backingStorePixelRatio","render","start_time","performance","now","Error","Promise","setTimeout","computeCellsBounds","resolve","fetchData","buffer","style","bc","scale","useBitBlit","resizeNotification","needsComputeCellsBounds","paintNow"],"mappings":"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","sourcesContent":["/******************************************************************************\n *\n * Copyright (c) 2017, the Perspective Authors.\n *\n * This file is part of the Perspective library, distributed under the terms of\n * the Apache License 2.0.  The full license can be found in the LICENSE file.\n *\n */\n\nimport rectangular from \"rectangular\";\nimport superscript from \"superscript-number\";\nimport isEqual from \"lodash/isEqual\";\n\nimport cellRenderersRegistry from \"faux-hypergrid/src/cellRenderers\";\n\nvar Borders = cellRenderersRegistry.BaseClass.extend(\"Borders\", {\n    paint: function(gc, config) {\n        var bounds = config.bounds,\n            x = bounds.x,\n            y = bounds.y,\n            w = bounds.width,\n            h = bounds.height - 1;\n        var color;\n\n        gc.save();\n        gc.translate(-0.5, 0.5); // paint \"sharp\" lines on pixels instead of \"blurry\" lines between pixels\n        gc.cache.lineWidth = 1;\n\n        color = config.borderTop;\n        if (color) {\n            gc.beginPath();\n            gc.moveTo(x, y);\n            gc.lineTo(x + w, y);\n            gc.cache.strokeStyle = color;\n            gc.stroke();\n        }\n\n        color = config.borderRight;\n        if (color) {\n            gc.beginPath();\n            gc.moveTo(x + w, y);\n            gc.lineTo(x + w, y + h);\n            gc.cache.strokeStyle = color;\n            gc.stroke();\n        }\n\n        color = config.borderBottom;\n        if (color) {\n            gc.beginPath();\n            gc.moveTo(x, y + h);\n            gc.lineTo(x + w, y + h);\n            gc.cache.strokeStyle = color;\n            gc.stroke();\n        }\n\n        color = config.borderLeft;\n        if (color) {\n            gc.beginPath();\n            gc.moveTo(x, y);\n            gc.lineTo(x, y + h);\n            gc.cache.strokeStyle = color;\n            gc.stroke();\n        }\n\n        gc.restore();\n    }\n});\n\ncellRenderersRegistry.add(Borders);\n\n/**\n * @this {Behavior}\n * @param payload\n */\nfunction setPSP(payload, force = false) {\n    const new_schema = [];\n\n    if (payload.isTree) {\n        new_schema[this.treeColumnIndex] = {\n            name: this.treeColumnIndex.toString(),\n            header: \" \" // space char because empty string defaults to `name`\n        };\n    }\n\n    payload.columnPaths.forEach(function(columnPath, columnIndex) {\n        const col_name = columnPath.join(\"|\"),\n            aliases = payload.configuration.columnAliases,\n            header = (aliases && aliases[col_name]) || col_name,\n            name = columnIndex.toString(),\n            type = payload.columnTypes[columnIndex];\n\n        if (payload.isTree && columnIndex === 0) {\n            new_schema[-1] = {name, header, type};\n        } else {\n            new_schema.push({name, header, type, index: columnIndex - (payload.isTree ? 1 : 0)});\n        }\n    });\n\n    this.grid.properties.showTreeColumn = payload.isTree;\n\n    const config = this.grid.behavior.dataModel._config;\n    const column_only = config.row_pivots.length === 0 && config.column_pivots.length > 0;\n    const selectable = !column_only && this.grid.behavior.dataModel._viewer.hasAttribute(\"selectable\");\n    this.grid.addProperties(this.grid.get_dynamic_styles(selectable));\n\n    // Following call to setData signals the grid to call createColumns and\n    // dispatch the fin-hypergrid-schema-loaded event (in that order). Here we\n    // inject a createColumns override into `this` (behavior instance) to\n    // complete the setup before the event is dispatched.\n    this.createColumns = createColumns;\n    this.refreshColumns = refreshColumns;\n\n    if (\n        !force &&\n        this._memoized_schema &&\n        isEqual(this._memoized_schema.slice(0, this._memoized_schema.length), new_schema.slice(0, new_schema.length)) &&\n        isEqual(payload.rowPivots, this._memoized_pivots)\n    ) {\n        this.grid.sbVScroller.index = 0;\n        this.grid.behavior.dataModel.data = payload.rows;\n        this.grid.behavior.dataModel._data_window = undefined;\n    } else {\n        this.grid.sbVScroller.index = 0;\n        this.grid.sbHScroller.index = 0;\n        this.grid.selectionModel.clear();\n        this.grid.setData({\n            data: payload.rows,\n            schema: new_schema\n        });\n    }\n    this._memoized_schema = new_schema;\n    this._memoized_pivots = payload.rowPivots;\n}\n\n/**\n * @this {Behavior}\n */\nfunction createColumns() {\n    Object.getPrototypeOf(this).createColumns.call(this);\n    this.refreshColumns();\n    this.setHeaders(); // grouped-header override that sets all header cell renderers and header row height\n    this.schema_loaded = true;\n}\n\nfunction refreshColumns() {\n    this.getActiveColumns().forEach(function(column) {\n        setColumnPropsByType.call(this, column);\n    }, this);\n\n    let treeColumn = this.getTreeColumn();\n    if (treeColumn) {\n        setColumnPropsByType.call(this, treeColumn);\n    }\n}\n\n/**\n * @this {Behavior}\n */\nfunction setColumnPropsByType(column) {\n    const props = column.properties;\n    if (column.index === this.treeColumnIndex) {\n        props.format = \"FinanceTree\";\n    } else {\n        props.format = `perspective-${column.type}`;\n    }\n    const config = this.grid.behavior.dataModel._config;\n    const isEditable = this.grid.behavior.dataModel._viewer.hasAttribute(\"editable\");\n    if (isEditable && config.row_pivots.length === 0 && config.column_pivots.length === 0) {\n        props.editor = {\n            integer: \"perspective-number\",\n            string: \"perspective-text\",\n            date: \"perspective-date\",\n            datetime: \"perspective-datetime\",\n            float: \"perspective-number\"\n        }[column.type];\n        Object.assign(props, {\n            editable: true,\n            editOnKeydown: true,\n            editOnNextCell: false,\n            editOnDoubleClick: true,\n            editorActivationKeys: [\"alt\", \"esc\"],\n            cellSelection: true\n        });\n    }\n    const styles = this.grid.get_styles();\n    if (styles[column.type]) {\n        Object.assign(props, styles[column.type]);\n    }\n}\n\n/**\n * @this {Behavior}\n */\nfunction formatColumnHeader(value) {\n    const config = this.dataModel.getConfig();\n    const index = config.sort.findIndex(item => item[0] === value.trim());\n\n    if (index > -1) {\n        const direction = config.sort[index][1];\n\n        if (direction in this.charMap) {\n            value = `${value} ${this.charMap[direction]}${config.sort.length > 1 ? superscript(index + 1) : \"\"}`;\n        }\n    }\n\n    return value;\n}\n\nfunction addSortChars(charMap) {\n    Object.assign(charMap, {\n        asc: \"\\u2191\",\n        desc: \"\\u2193\",\n        \"asc abs\": \"\\u21E7\",\n        \"desc abs\": \"\\u21E9\",\n        \"col asc\": \"\\u2192\",\n        \"col desc\": \"\\u2190\",\n        \"col asc abs\": \"\\u21E8\",\n        \"col desc abs\": \"\\u21E6\"\n    });\n}\n\nfunction sortColumn(event) {\n    event.preventDefault();\n    event.handled = true;\n    const config = this.behavior.dataModel.getConfig();\n    const column = this.behavior.getColumn(event.detail.column);\n    let column_sorting, column_name;\n\n    if (config.column_pivots.length > 0) {\n        column_sorting = true;\n        column_name = column.header.split(\"|\")[config.column_pivots.length]; // index of last column is always the length of the column pivots\n    } else {\n        column_sorting = false;\n        column_name = column.header;\n    }\n\n    const viewer = this.behavior.dataModel._viewer;\n\n    const item_index = config.sort.findIndex(item => item[0] === column_name.trim());\n    const already_sorted = item_index > -1;\n\n    // shift key to enable abs sorting alt key to not remove already sorted\n    // columns\n    const abs_sorting = event.detail.keys && (event.detail.keys.indexOf(\"ALTSHIFT\") > -1 || event.detail.keys.indexOf(\"ALT\") > -1) && column.type !== \"string\";\n    const shift_pressed = event.detail.keys && (event.detail.keys.indexOf(\"ALTSHIFT\") > -1 || event.detail.keys.indexOf(\"SHIFT\") > -1);\n    let new_sort_direction;\n\n    // if the column is already sorted we increment the sort\n    if (already_sorted) {\n        const item = config.sort[item_index];\n        const direction = item[1];\n        new_sort_direction = viewer._increment_sort(direction, column_sorting, abs_sorting);\n        item[1] = new_sort_direction;\n    } else {\n        new_sort_direction = viewer._increment_sort(\"none\", column_sorting, abs_sorting);\n    }\n\n    //if alt pressed and column is already sorted, we change the sort for the\n    //column and leave the rest as is\n    if (shift_pressed && already_sorted) {\n        if (new_sort_direction === \"none\") {\n            config.sort.splice(item_index, 1);\n        }\n        viewer.sort = JSON.stringify(config.sort);\n    } else if (shift_pressed) {\n        // if alt key is pressed and column is NOT already selected, append the\n        // new sort column\n        config.sort.push([column_name, new_sort_direction]);\n        viewer.sort = JSON.stringify(config.sort);\n    } else {\n        viewer.sort = JSON.stringify([[column_name, new_sort_direction]]);\n    }\n}\n\nconst right_click_handler = e => {\n    const old_event = e.detail.primitiveEvent;\n    const new_event = new MouseEvent(old_event.type, old_event);\n    e.target.parentElement.parentElement.parentElement.dispatchEvent(new_event);\n};\n\nasync function getCellConfig(row_idx, col_idx) {\n    const config = this.dataModel.getConfig();\n    const row_pivots = config.row_pivots;\n    const column_pivots = config.column_pivots;\n    const start_row = row_idx >= 0 ? row_idx : 0;\n    const end_row = start_row + 1;\n    const r = await this.dataModel._view.to_json({start_row, end_row});\n    const row_paths = r.map(x => x.__ROW_PATH__);\n    const row_pivots_values = row_paths[0] || [];\n    const row_filters = row_pivots\n        .map((pivot, index) => {\n            const pivot_value = row_pivots_values[index];\n            return pivot_value ? [pivot, \"==\", pivot_value] : undefined;\n        })\n        .filter(x => x);\n    const column_index = row_pivots.length > 0 ? col_idx + 1 : col_idx;\n    const column_paths = Object.keys(r[0])[column_index];\n    const result = {row: r[0]};\n    let column_filters = [];\n    if (column_paths) {\n        const column_pivot_values = column_paths.split(\"|\");\n        result.column_names = [column_pivot_values[column_pivot_values.length - 1]];\n        column_filters = column_pivots\n            .map((pivot, index) => {\n                const pivot_value = column_pivot_values[index];\n                return pivot_value ? [pivot, \"==\", pivot_value] : undefined;\n            })\n            .filter(x => x)\n            .filter(([, , value]) => value !== \"__ROW_PATH__\");\n    }\n\n    const filters = config.filter.concat(row_filters).concat(column_filters);\n    result.config = {filters};\n    return result;\n}\n// `install` makes this a Hypergrid plug-in\nexport const install = function(grid) {\n    addSortChars(grid.behavior.charMap);\n\n    Object.getPrototypeOf(grid.behavior).setPSP = setPSP;\n\n    Object.getPrototypeOf(grid.behavior).formatColumnHeader = formatColumnHeader;\n\n    grid.addEventListener(\"fin-column-sort\", sortColumn.bind(grid));\n\n    grid.addEventListener(\"fin-canvas-context-menu\", right_click_handler);\n    grid.addEventListener(\"fin-row-selection-changed\", async function(event) {\n        const rows = event.detail.rows;\n\n        const selected = rows.length > 0;\n        const detail = selected ? await getCellConfig.call(event.detail.grid.behavior, rows[0]) : {config: {filters: []}};\n\n        event.detail.grid.canvas.dispatchEvent(\n            new CustomEvent(\"perspective-select\", {\n                bubbles: true,\n                composed: true,\n                detail: {selected, ...detail}\n            })\n        );\n    });\n\n    Object.getPrototypeOf(grid.behavior).getCursorAt = function(x, y, event) {\n        const rp_len = this.dataModel.data[y - 1]?.[-1]?.rowPath?.length;\n        const is_select = !!this.grid.properties.rowSelection;\n        if (is_select) {\n            if (x === -1 && rp_len <= this.dataModel._config.row_pivots.length && event?.gridPoint.x <= rp_len * 15 + 10) {\n                return \"pointer\";\n            }\n        } else {\n            if (x === -1 && rp_len <= this.dataModel._config.row_pivots.length) {\n                return \"pointer\";\n            }\n        }\n    };\n\n    function updateCursor(event) {\n        var cursor = this.behavior.getCursorAt(-1, -1);\n        var hoverCell = this.hoverCell;\n        if (hoverCell && hoverCell.x > -2 && hoverCell.y > -1) {\n            var x = hoverCell.x + this.getHScrollValue();\n            cursor = this.behavior.getCursorAt(x, hoverCell.y + this.getVScrollValue(), event);\n        }\n        this.beCursor(cursor);\n    }\n\n    Object.getPrototypeOf(grid.behavior).onMouseMove = function(grid, event) {\n        if (this.featureChain) {\n            this.featureChain.handleMouseMove(grid, event);\n            updateCursor.call(grid, event);\n            this.featureChain.setCursor(grid);\n        }\n    };\n\n    Object.getPrototypeOf(grid.behavior).cellClicked = async function(event) {\n        event.primitiveEvent.preventDefault();\n        event.handled = true;\n        const {x, y} = event.dataCell;\n        const config = this.dataModel.getConfig();\n        const row_pivots = config.row_pivots;\n        const column_pivots = config.column_pivots;\n        const start_row = y >= 0 ? y : 0;\n        const end_row = start_row + 1;\n        const r = await this.dataModel._view.to_json({start_row, end_row});\n        const row_paths = r.map(x => x.__ROW_PATH__);\n        const row_pivots_values = row_paths[0] || [];\n        const row_filters = row_pivots\n            .map((pivot, index) => {\n                const pivot_value = row_pivots_values[index];\n                return pivot_value ? [pivot, \"==\", pivot_value] : undefined;\n            })\n            .filter(x => x);\n        const column_index = row_pivots.length > 0 ? x + 1 : x;\n        const column_paths = Object.keys(r[0])[column_index];\n        let column_filters = [];\n        let column_names;\n        if (column_paths) {\n            const column_pivot_values = column_paths.split(\"|\");\n            column_names = [column_pivot_values[column_pivot_values.length - 1]];\n            column_filters = column_pivots\n                .map((pivot, index) => {\n                    const pivot_value = column_pivot_values[index];\n                    return pivot_value ? [pivot, \"==\", pivot_value] : undefined;\n                })\n                .filter(x => x)\n                .filter(([, , value]) => value !== \"__ROW_PATH__\");\n        }\n\n        const filters = config.filter.concat(row_filters).concat(column_filters);\n\n        // this only works for single row select (which is all we support\n        // right now)\n        if (this.grid.properties.rowSelection) {\n            const selected_rows = this.grid.getSelectedRows();\n            const selected = selected_rows[0] === y;\n            if (selected_rows.length === 0) {\n                delete this.dataModel[\"_selected_row_index\"];\n            }\n            this.grid.canvas.dispatchEvent(\n                new CustomEvent(\"perspective-select\", {\n                    bubbles: true,\n                    composed: true,\n                    detail: {\n                        selected,\n                        config: {filters: selected ? filters : []},\n                        column_names,\n                        row: r[0]\n                    }\n                })\n            );\n        }\n        this.grid.canvas.dispatchEvent(\n            new CustomEvent(\"perspective-click\", {\n                bubbles: true,\n                composed: true,\n                detail: await getCellConfig.call(this, y, x)\n            })\n        );\n\n        const rp_len = this.dataModel.data[y]?.[-1]?.rowPath?.length;\n        const is_toggle = !this.grid.properties.rowSelection || event?.gridPoint.x <= rp_len * 15 + 10;\n\n        if (is_toggle) {\n            return this.dataModel.toggleRow(event.dataCell.y, event.dataCell.x, event);\n        }\n    };\n\n    // Prevents flashing of cell selection on scroll\n    const renderGrid = grid.renderer.renderGrid;\n    grid.renderer.renderGrid = function(gc) {\n        renderGrid.call(this, gc);\n        this.renderOverrides(gc);\n        this.renderLastSelection(gc);\n    };\n\n    grid.canvas.canvas.addEventListener(\"mousewheel\", e => {\n        if (e.shiftKey) {\n            e.stopPropagation();\n        }\n    });\n\n    // Corrects for deselection behavior on keyiup due to shadow-dom\n    grid.canvas.hasFocus = function() {\n        if (!grid.div?.isConnected) {\n            return;\n        }\n        const grid_element = grid.div.parentNode.parentNode.host;\n        const view_shadow_root = grid_element.parentNode.parentNode.parentNode.parentNode.parentNode;\n        return view_shadow_root.activeElement === grid_element;\n    };\n\n    // Disable cell selection dragging\n    grid.lookupFeature(\"CellSelection\").handleMouseDown = function(grid, event) {\n        var dx = event.gridCell.x,\n            dy = event.dataCell.y,\n            isSelectable = grid.behavior.getCellProperty(event.dataCell.x, event.gridCell.y, \"cellSelection\");\n\n        if (isSelectable && event.isDataCell && !event.primitiveEvent.detail.isRightClick) {\n            var dCell = grid.newPoint(dx, dy),\n                primEvent = event.primitiveEvent,\n                keys = primEvent.detail.keys;\n            this.extendSelection(grid, dCell, keys);\n        } else if (this.next) {\n            this.next.handleMouseDown(grid, event);\n        }\n    };\n\n    // Disable cell selection by shift-click\n    grid.lookupFeature(\"CellSelection\").extendSelection = function(grid, gridCell, keys) {\n        var hasCTRL = keys.indexOf(\"CTRL\") >= 0,\n            hasSHIFT = false,\n            mousePoint = grid.getMouseDown(),\n            x = gridCell.x, // - numFixedColumns + scrollLeft;\n            y = gridCell.y; // - numFixedRows + scrollTop;\n\n        //were outside of the grid do nothing\n        if (x < 0 || y < 0) {\n            return;\n        }\n\n        //we have repeated a click in the same spot deslect the value from last\n        //time\n        if (hasCTRL && x === mousePoint.x && y === mousePoint.y) {\n            grid.clearMostRecentSelection();\n            grid.popMouseDown();\n            grid.repaint();\n            return;\n        }\n\n        if (!hasCTRL && !hasSHIFT) {\n            grid.clearSelections();\n        }\n\n        if (hasSHIFT) {\n            grid.clearMostRecentSelection();\n            grid.select(mousePoint.x, mousePoint.y, x - mousePoint.x, y - mousePoint.y);\n            grid.setDragExtent(grid.newPoint(x - mousePoint.x, y - mousePoint.y));\n        } else {\n            grid.select(x, y, 0, 0);\n            grid.setMouseDown(grid.newPoint(x, y));\n            grid.setDragExtent(grid.newPoint(0, 0));\n        }\n        grid.repaint();\n    };\n\n    // Prevent multiple cell moves while pressing navigation keys while editing.\n    grid.lookupFeature(\"CellSelection\").handleDOWN = function(grid, event) {\n        event.primitiveEvent.preventDefault();\n        if (!grid.cellEditor) {\n            const count = this.getAutoScrollAcceleration();\n            let {x, y} = grid.selectionModel.getLastSelection().origin;\n            const max = grid.renderer.dataWindow.origin.y + grid.renderer.dataWindow.extent.y - 2;\n            if (y + count > max) {\n                grid.sbVScroller.index++;\n            }\n            y = Math.min(grid.behavior.dataModel.getRowCount() - 1, y + count);\n            grid.selectionModel.select(x, y, 0, 0);\n            grid.repaint();\n        }\n    };\n\n    grid.lookupFeature(\"CellSelection\").handleUP = function(grid, event) {\n        event.primitiveEvent.preventDefault();\n        if (!grid.cellEditor) {\n            const count = this.getAutoScrollAcceleration();\n            let {x, y} = grid.selectionModel.getLastSelection().origin;\n            const min = grid.renderer.dataWindow.origin.y;\n            if (y - count < min) {\n                grid.sbVScroller.index--;\n            }\n            y = Math.max(0, y - count);\n            grid.selectionModel.select(x, y, 0, 0);\n            grid.repaint();\n        }\n    };\n\n    grid.lookupFeature(\"CellSelection\").handleLEFT = function(grid, event) {\n        event.primitiveEvent.preventDefault();\n        if (!grid.cellEditor) {\n            const count = this.getAutoScrollAcceleration();\n            let {x, y} = grid.selectionModel.getLastSelection().origin;\n            const min = grid.renderer.dataWindow.origin.x;\n            if (x - count < min) {\n                grid.sbHScroller.index--;\n            }\n            x = Math.max(0, x - 1);\n            grid.selectionModel.select(x, y, 0, 0);\n            grid.repaint();\n        }\n    };\n\n    grid.lookupFeature(\"CellSelection\").handleRIGHT = function(grid, event) {\n        event.primitiveEvent.preventDefault();\n        if (!grid.cellEditor) {\n            const count = this.getAutoScrollAcceleration();\n            let {x, y} = grid.selectionModel.getLastSelection().origin;\n            const max = grid.renderer.dataWindow.origin.x + grid.renderer.dataWindow.extent.x - 1;\n            if (x + count > max) {\n                grid.sbHScroller.index++;\n            }\n            x = Math.min(grid.behavior.schema.length - 1, x + count);\n            grid.selectionModel.select(x, y, 0, 0);\n            grid.repaint();\n        }\n    };\n\n    grid.lookupFeature(\"CellSelection\").moveShiftSelect = function(grid, offsetX, offsetY) {\n        grid.moveSingleSelect(offsetX, offsetY);\n    };\n\n    function update_bounds() {\n        this.width = Math.floor(this.div.clientWidth);\n        this.height = Math.floor(this.div.clientHeight);\n        this.bounds = new rectangular.Rectangle(0, 0, this.width, this.height);\n        this.component.setBounds(this.bounds);\n    }\n\n    grid.canvas.resize = async function(force) {\n        //fix ala sir spinka, see\n        //http://www.html5rocks.com/en/tutorials/canvas/hidpi/ just add 'hdpi'\n        //as an attribute to the fin-canvas tag\n        let ratio = 1;\n        const isHIDPI = window.devicePixelRatio && this.component.properties.useHiDPI;\n        if (isHIDPI) {\n            const devicePixelRatio = window.devicePixelRatio || 1;\n            const backingStoreRatio =\n                this.gc.webkitBackingStorePixelRatio || this.gc.mozBackingStorePixelRatio || this.gc.msBackingStorePixelRatio || this.gc.oBackingStorePixelRatio || this.gc.backingStorePixelRatio || 1;\n\n            ratio = devicePixelRatio / backingStoreRatio;\n        }\n\n        update_bounds.call(this);\n\n        let render = true;\n        const start_time = performance.now();\n        const dataModel = this.component.grid.behavior.dataModel;\n        if (this.height * ratio !== this.canvas.height || this.width * ratio !== this.canvas.width || force) {\n            while (dataModel._view && render) {\n                if (performance.now() - start_time > 3000) {\n                    throw new Error(\"Timeout\");\n                }\n                if (typeof render === \"object\") {\n                    // If we are awaiting this grid's initialization, yield\n                    // until it is ready.\n                    await new Promise(setTimeout);\n                }\n                grid.renderer.computeCellsBounds(true);\n                render = await new Promise(resolve => dataModel.fetchData(undefined, resolve));\n            }\n        }\n\n        this.buffer.width = this.canvas.width = this.width * ratio;\n        this.buffer.height = this.canvas.height = this.height * ratio;\n\n        this.canvas.style.width = this.buffer.style.width = this.width + \"px\";\n        this.canvas.style.height = this.buffer.style.height = this.height + \"px\";\n\n        this.bc.scale(ratio, ratio);\n        if (isHIDPI && !this.component.properties.useBitBlit) {\n            this.gc.scale(ratio, ratio);\n        }\n        if (dataModel._view) {\n            this.resizeNotification();\n        }\n        this.component.grid.renderer.needsComputeCellsBounds = false;\n        grid.canvas.paintNow();\n    };\n};\n"],"file":"perspective-plugin.js"}